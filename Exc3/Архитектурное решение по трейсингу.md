### Архитектурное решение по трейсингу

---

#### Мотивация

Внедрение трейсинга в системе компании «Александрит» решает следующие задачи:

1. **Выявление узких мест**:
   - Сокращение времени диагностики проблем с заказами.
   - Возможность точно определить, на каком этапе и в каком сервисе произошёл сбой.

2. **Повышение надёжности**:
   - Снижение количества зависших заказов за счёт более быстрой реакции на сбои.
   - Выявление утерянных сообщений в RabbitMQ.

3. **Улучшение клиентского опыта**:
   - Быстрая обработка жалоб на зависшие заказы.
   - Повышение лояльности клиентов за счёт сокращения времени простоя заказов.

4. **Оптимизация процессов**:
   - Возможность анализа производительности каждого этапа обработки заказов.
   - Улучшение SLA и предотвращение потери крупных контрактов.

**Метрики, на которые повлияет трейсинг**:
- **Технические**: уменьшение времени обнаружения и устранения неисправностей (MTTD/MTTR), сокращение доли потерянных сообщений.
- **Бизнесовые**: рост клиентской удовлетворённости (NPS), снижение количества жалоб, улучшение SLA на выполнение заказов.

---

#### Системы, которые следует покрыть трейсингом

1. **Онлайн-магазин (Shop)**:
   - Создание и изменение статусов заказов.
   - Передача заказов в очередь RabbitMQ.

2. **MES**:
   - Расчёт стоимости заказа.
   - Смена статусов заказов (MANUFACTURING_STARTED, PACKAGING и др.).
   - Завершение обработки заказов.

3. **CRM**:
   - Согласование заказов на производство.
   - Завершение заказа (CLOSED).
   - Связь с транспортными компаниями.

**Ключевые точки, где заказ может «сломаться» или зависнуть**:
- Потеря сообщения в RabbitMQ.
- Ошибка обработки заказа в MES.
- Некорректная синхронизация статусов между MES и CRM.
- Ошибки передачи данных между онлайн-магазином и MES.

---

#### Список данных для трейсинга

- **ID заказа** (уникальный идентификатор для отслеживания).
- **Временные метки (timestamps)** для каждой операции.
- **Статус обработки заказа** (INITIATED, SUBMITTED и др.).
- **ID сообщения RabbitMQ** (для идентификации утерянных сообщений).
- **Служебные данные**:
  - Сервис, инициировавший операцию.
  - Технический код ответа (успех/ошибка).
- **Ошибка (если возникла)**:
  - Код и описание.
  - Стек вызовов.
- **Задержка обработки** (latency) на каждом этапе.

---

#### Предлагаемое решение

1. **Технологии**:
   - **OpenTelemetry** для сбора трейсинговых данных.
   - **Jaeger** или **Zipkin** для визуализации трейсинга.
   - Интеграция с существующими логгером (например, ELK-стек) для полной картины.

2. **Компоненты**:
   - Добавить агенты OpenTelemetry в:
     - Backend онлайн-магазина (Java Spring Boot).
     - MES (C#).
     - CRM (Java Spring Boot).
   - Настроить экспортеры данных трейсинга в Jaeger/Zipkin.
   - Интегрировать трейсинг с RabbitMQ (используя плагины или библиотеки для OpenTelemetry).

3. **Новая схема системы с трейсингом**:
   - Backend-сервисы отправляют трейсинговые данные в collector OpenTelemetry.
   - Collector агрегирует и отправляет данные в хранилище (например, Jaeger).
   - Данные визуализируются для операторов.

---

#### Компромиссы

- **Проприетарные компоненты**: MES как система с закрытым кодом может требовать значительных доработок для поддержки OpenTelemetry.
- **Нагрузка на систему**: сбор трейсинговых данных увеличит потребление ресурсов, потребуется масштабирование инфраструктуры.
- **Время внедрения**: интеграция может занять до нескольких месяцев из-за сложности взаимодействия систем.

---

#### Аспекты безопасности

1. **Аутентификация и авторизация**:
   - Доступ к системе трейсинга только у сотрудников с ролями «Поддержка» или «Администратор».
   - Использование SSO для удобства управления доступом.

2. **Шифрование данных**:
   - Шифрование данных трейсинга в транзите (TLS).
   - Настройка ротации ключей шифрования.

3. **Ограничение объёма данных**:
   - Исключение из трейсинга личных данных клиентов (PII).
   - Анонимизация чувствительных данных.

---

#### Автоматический мониторинг и алертинг (дополнительное задание)

1. **Мониторинг**:
   - Создать графики для трейсинговых метрик (например, время обработки на каждом этапе).
   - Определить SLA для каждой операции.

2. **Алерты**:
   - Настроить уведомления при:
     - Превышении времени обработки заказа (больше 30 минут).
     - Потере сообщений RabbitMQ.
     - Ошибке в интеграции между системами.

3. **Технологии**:
   - Интеграция трейсинга с Prometheus для сбора SLA-метрик.
   - Настройка алертов через Grafana/Alertmanager.

**Связи на схеме**: 
Добавить маршруты для данных из RabbitMQ и приложений в OpenTelemetry collector, а затем в Prometheus и Jaeger.

