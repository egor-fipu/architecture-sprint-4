### Архитектурное решение по логированию

---

#### Мотивация

Внедрение системного логирования в IT-ландшафт компании «Александрит» решает следующие задачи:

1. **Сокращение времени диагностики**:
   - Ускорение поиска и устранения ошибок за счёт централизованного доступа к данным.

2. **Повышение прозрачности работы системы**:
   - Возможность прослеживать действия и изменения в системе.
   - Логирование нестандартных ситуаций для их анализа.

3. **Предупреждение инцидентов**:
   - Своевременное обнаружение аномалий и отклонений от нормы.

4. **Улучшение клиентского опыта**:
   - Снижение времени ответа на запросы клиентов о проблемах с заказами.

**Метрики, на которые повлияет внедрение логирования**:
- Технические: сокращение MTTD (времени на обнаружение проблем) и MTTR (времени на устранение проблем).
- Бизнесовые: снижение количества возвратов, увеличение NPS клиентов, сокращение нагрузки на техническую поддержку.

---

#### Системы, из которых требуется собирать логи

1. **Онлайн-магазин (Shop)**:
   - Изменение статусов заказов.
   - Ошибки API (например, HTTP 500).
   - Запросы от пользователей (API и фронтенд).

2. **MES**:
   - Обработка заказов (изменение статусов, запуск производства, завершение).
   - Ошибки обработки данных.

3. **CRM**:
   - Синхронизация данных заказов с другими системами.
   - Обработка запросов клиентов (внесение изменений в заказы).

4. **RabbitMQ**:
   - Потерянные или отложенные сообщения.
   - Превышение лимита очередей.

---

#### Список необходимых логов

**Уровень INFO**:
- **Онлайн-магазин (Shop)**:
  - Время изменения статуса заказа, идентификатор заказа, идентификатор пользователя, новый статус.
  - Время входа пользователя в систему (ID пользователя).
  - Время отправки данных в RabbitMQ, ID сообщения.
- **MES**:
  - Время начала и завершения обработки заказа (ID заказа, статус).
  - Время ошибки обработки (код ошибки, описание).
- **CRM**:
  - Время успешной синхронизации заказа (ID заказа, изменения).
  - ID сотрудника, изменившего статус или данные заказа.
- **RabbitMQ**:
  - Время попадания сообщения в dead-letter queue (ID сообщения).
  - Время превышения лимита очереди (название очереди, размер).

**Уровень DEBUG**:
- Полные запросы и ответы (без чувствительных данных).
- Входные параметры функций.

**Уровень ERROR**:
- Ошибки API (код ошибки, URI, тело запроса).
- Системные ошибки RabbitMQ.

**Уровень WARNING**:
- Долгое выполнение запросов (например, >2 секунд).
- Потенциальные проблемы с синхронизацией данных (например, задержка >1 минуты).

---

#### Системы с приоритетным логированием и трейсингом

1. **Приоритет 1: Онлайн-магазин и RabbitMQ**:
   - Максимальная вовлечённость клиентов.
   - Ключевые точки передачи данных.

2. **Приоритет 2: MES**:
   - Высокая вероятность ошибок обработки.
   - Важность для завершения заказов.

3. **Приоритет 3: CRM**:
   - Связь с клиентами и внешними сервисами.

---

#### Предлагаемое решение

1. **Технологии**:
   - **Elasticsearch, Logstash и Kibana (ELK)** для централизованного сбора и анализа логов.
   - **Fluentd** для агрегирования логов из различных источников.
   - **Filebeat** для передачи логов с серверов приложений в центральное хранилище.

2. **Компоненты**:
   - Логгеры в каждом микросервисе (например, `logback` для Java, `log4net` для C#, `python-logging`).
   - Централизованное хранилище для логов (Elasticsearch).
   - Дашборды для визуализации (Kibana).

3. **Схема**:
   - Микросервисы → Filebeat → Fluentd → Logstash → Elasticsearch → Kibana.

---

#### Политика безопасности

1. **Доступ**:
   - Логи доступны только авторизованным пользователям с ролями «Администратор» и «Поддержка».
   - Включить двухфакторную аутентификацию.

2. **Чувствительные данные**:
   - Исключить из логов данные PII (личная информация клиентов).
   - Анонимизация данных, если необходимо логировать идентификаторы пользователей.

---

#### Политика хранения

1. **Разделение индексов**:
   - Разные индексы для разных систем (Shop, MES, CRM, RabbitMQ).
   - Индексы по уровням логирования (INFO, ERROR, DEBUG).

2. **Срок хранения**:
   - INFO: 30 дней.
   - ERROR: 90 дней.
   - DEBUG: 7 дней.

3. **Размер индекса**:
   - Лимит индекса 50 ГБ, после чего создаётся новый индекс.

---

#### Превращение системы сбора логов в систему анализа

1. **Алертинг**:
   - Настроить алерты для критических событий:
     - Увеличение количества HTTP 500.
     - Потеря сообщений в RabbitMQ.
     - Задержка обработки заказов.

2. **Поиск аномалий**:
   - Использовать ML-модули Elasticsearch для анализа аномального поведения (например, резкий рост заказов).

3. **Действия при инцидентах**:
   - Создание тикетов в Jira.
   - Уведомления команды поддержки (Slack, email).
   - Автоматическое масштабирование инфраструктуры в случае перегрузки.

